# SkyX protocol v1.337145522

## Я не знаю, что такое документация
| Файл           | Описание |
|----------------|----------|
| dh.py          | Формирование публичных ключей DH. Их обработку и генерации сессионного ключа. DiffieHellman, короче, КЛАССИКА. |
| packet.py      | Собственно пакетики, формируемые нехитрым образом. Основа протокола |
| packet_type.py | Описывает доступные типы пакетов в протоколе |
| transport.py   | Там магия в виде запуска ъендщейка и приема пакета из сокета. Это могло называться и utils.py, но разве тогда это бы выглядело __так__ круто =) |


## Структура пакета
| HEADERS                     | Payload                          |  
|-----------------------------|----------------------------------|
| [PACKET_ID] [DATA_LENGTH]   | [IV] [ENC_DATA] [HMAC(ENC_DATA)] |

| [PACKET_ID] | [DATA_LENGTH] | [IV]     | [ENC_DATA] | [HMAC(ENC_DATA)] |
|-------------|---------------|----------|------------|------------------|
| 1 Byte      | 2 Bytes       | 16 Bytes | XX Bytes   | 32 Bytes         |

## Пакеты
| Название  | ID    |
|-----------|-------|
| SkyXHello | 0x00  |
| Event     | 0x01  |
| Message   | 0x05  |
| File      | 0x06  |

## Содержание пакетов
| Пакет     | Направление      | Данные |
|-----------|------------------|--------|
| SkyXHello | Client <- Server | Key exchange chain: list[RSA_PUB_KEY_FINGERPRINT] |
| SkyXHello | Client = Client  | NEXT_UNIT_IN_CHAIN_RSA_PUB_KEY_FINGERPRINT + DH_PUB_KEY |
| Event     | Client <- Server | EventType + args |
| Message   | Client = Client  | RSA_PUB_KEY_FINGERPRINT + Message |
| File      | ?                | ? |

## Инициализация соединения и ъендшейк
1. Клиент подключается к 1604/tcp.
2. Сервер отправляет свой открытый ключ.
3. Клиент отправляет свой открытый ключ, ???? зашифрованный открытым ключем сервера, серверу.
4. Сервер проверяет наличие ключа клиента в белом списке.
5. Сервер создает т.н. цепочку. Согласно которой будет производиться обмен ключами по DH. Рассылает ее всем подключенным в виде списка хэшей открытых ключей подключенных устройств/клиентов
6. [Тут обмен ключами]
7. Если все хорошо установка соединения завершена

## Обмен ключами
1. Сервер генерирует т.н. цепочку обмена ключами
	1. Цепочка состоит из хэшей открытых ключей подключенных клиентов
2. Сервер отправляет всем подключенным клиентам 2 SkyXHello пакета с:
	1. Цепочкой обмена
	2. Параметрами g, p для алгоритма Диффи-Хеллмана
3. Клиенты получают эти пакеты и начинают обмен:
	1. Найти следующего в цепочке обмена `chain[my_hash_index + 1]`
	2. Сгенерировать публичный ключ Диффи-Хеллмана `g^a mod p`
	3. Отправить его следующему учаснику.
	4. Принять открытый ключ предыдущего учасника.
	5. Сделать с ним п. ii. `(g^c)^a mod p`
	6. Отправить результат п v. следующему учаснику.
	7. Принять от предыдущего учасника `(g^b)^c mod p`
	8. Сгенерировать сессионный ключ из последнего пакета.
	9. EZ

#### Как сервер проверяет открытый ключ
- Ключи хранятся в "хранилище ебать"
- Каждый ключ назван `f"{SHA256(PUB_KEY).hexdigest()}.pem"`

1. Когда серверу приходит ключ он ищет его в "хранилище ебать"
2. Если его там нет клиент отключается сервером КХУЯМ.
3. Сервер подписывает 32 случайных байта ключем клиента.
4. Клиент должен отправить их в обратном порядке, подписав ключем сервера соответственно.
5. Я не знаю зачем так изъебываться я просто так хочу.

